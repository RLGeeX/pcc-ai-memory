# Phase 2.1: Plan AlloyDB Cluster Configuration

**Phase**: 2.1 (AlloyDB Infrastructure - Cluster Design)
**Duration**: 20-25 minutes
**Type**: Planning
**Status**: ðŸ“‹ Planning (Not Started)
**Date**: TBD (10/20+)

---

## Objective

Design the AlloyDB cluster configuration for the devtest environment, including high availability, backup strategy, PITR, sizing, and PSC connectivity.

## Prerequisites

âœ… Phase 1.4 completed (Network infrastructure deployed, overflow subnet available)
âœ… `pcc-prj-app-devtest` GCP project exists
âœ… Understanding of AlloyDB architecture and features
âœ… Service requirements documented (7 microservices)

---

## Cluster Configuration Design

### Deployment Location

**GCP Project**: `pcc-prj-app-devtest`
**Region**: `us-east4`
**Network**: `pcc-vpc-nonprod` (in `pcc-prj-net-shared`)
**PSC Connectivity**: Auto-created by AlloyDB when `psc_enabled = true`

### High Availability Configuration

**Multi-Zone HA**:
- **Primary Instance**: `us-east4-a`
- **Standby Instance**: `us-east4-b`
- **Failover**: Automatic (Google-managed)
- **RTO Target**: <5 minutes (recovery time objective)
- **RPO Target**: <5 minutes (recovery point objective)

**Architecture**:
```
Primary Instance (us-east4-a)
    â†“ Synchronous Replication
Standby Instance (us-east4-b)
```

**Benefits**:
- Automatic failover within same region
- No data loss during zone failure
- Transparent to applications (same connection string)

---

### Backup Strategy

**Automated Backups**:
- **Frequency**: Daily
- **Retention**: 30 days
- **Backup Window**: 2:00 AM - 4:00 AM EST (low-traffic period)
- **Type**: Full automated backups (Google-managed)

**Point-in-Time Recovery (PITR)**:
- **Window**: 7 days
- **Granularity**: Any second within 7-day window
- **Use Case**: Recover from logical errors (bad migrations, data corruption)

**Backup Encryption**:
- **At Rest**: Google-managed encryption keys
- **In Transit**: TLS 1.2+

---

### Cluster Sizing

**Initial Sizing** (devtest environment):

**Primary Instance**:
- **vCPUs**: 2
- **Memory**: 8 GB
- **Storage**: 100 GB (auto-scaling enabled up to 1 TB)
- **Machine Type**: `db-standard-2`

**Replica Instance** (read-only):
- **vCPUs**: 2
- **Memory**: 8 GB
- **Storage**: Matches primary
- **Machine Type**: `db-standard-2`

**Rationale**:
- 7 microservices Ã— ~1-2 GB memory each = 7-14 GB memory (8 GB sufficient for devtest)
- 2 vCPUs handle typical devtest workload
- Storage auto-scales as data grows
- Can scale up for production

**Performance Considerations**:
- Connection pooling per service: ~10-20 connections
- Total connections: 7 services Ã— 15 avg = ~105 connections
- AlloyDB default: 500 max connections (plenty of headroom)

---

### Network Connectivity

**Private Service Connect (Auto-Created)**:
- **PSC Enabled**: AlloyDB automatically creates PSC service attachments when `psc_enabled = true`
- **VPC Network**: `pcc-vpc-nonprod` (in `pcc-prj-net-shared`)
- **Connection**: Private IP only (no public IP)
- **DNS**: PSC DNS name auto-generated by AlloyDB
- **No Manual Config**: AlloyDB handles PSC routing internally

**Connection Methods**:
- **Recommended**: AlloyDB Auth Proxy (handles PSC internally, simplest setup)
- **Alternative**: Direct connection via PSC DNS name (from cluster resource)
- **Primary**: Read-write access
- **Replica**: Read-only access

---

### Security Configuration

**Authentication**:
- **PostgreSQL**: Username/password (stored in Secret Manager)
- **IAM**: Google Cloud IAM authentication (for Auth Proxy)

**Encryption**:
- **At Rest**: Google-managed encryption
- **In Transit**: TLS 1.2+ enforced
- **Certificate**: Google-managed certificate

**Network Security**:
- **Private IP only**: No public internet access
- **PSC**: Traffic stays within Google network
- **VPC Service Controls**: Optional (can add in future)

---

### Maintenance Windows

**Google-Managed Maintenance**:
- **Window**: Sunday 2:00 AM - 6:00 AM EST
- **Frequency**: Monthly (patches, upgrades)
- **Disruption**: Minimal (failover to standby, <5min downtime)

**User-Controlled Updates**:
- **Minor Versions**: Auto-applied during maintenance window
- **Major Versions**: User-initiated (not auto-applied)

---

## Terraform Resource Design

### Cluster Resource

```hcl
resource "google_alloydb_cluster" "devtest" {
  cluster_id   = "pcc-alloydb-cluster-devtest"
  location     = "us-east4"
  project      = "pcc-prj-app-devtest"

  # PSC auto-created by AlloyDB - no manual forwarding rule needed
  psc_config {
    psc_enabled = true
  }

  automated_backup_policy {
    enabled = true
    backup_window {
      start_times {
        hours   = 2  # 2 AM EST
        minutes = 0
      }
    }
    quantity_based_retention {
      count = 30  # 30 days
    }
    weekly_schedule {
      days_of_week = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"]
    }
  }

  continuous_backup_config {
    enabled              = true
    recovery_window_days = 7
  }

  labels = {
    environment = "devtest"
    purpose     = "shared-database"
    managed_by  = "terraform"
  }
}
```

### Primary Instance

```hcl
resource "google_alloydb_instance" "devtest_primary" {
  cluster       = google_alloydb_cluster.devtest.name
  instance_id   = "pcc-alloydb-instance-devtest-primary"
  instance_type = "PRIMARY"

  machine_config {
    cpu_count = 2
  }

  availability_type = "REGIONAL"

  database_flags = {
    "max_connections" = "500"
  }

  labels = {
    environment = "devtest"
    role        = "primary"
    managed_by  = "terraform"
  }
}
```

### Replica Instance (Read-Only)

```hcl
resource "google_alloydb_instance" "devtest_replica" {
  cluster       = google_alloydb_cluster.devtest.name
  instance_id   = "pcc-alloydb-instance-devtest-replica"
  instance_type = "READ_POOL"

  machine_config {
    cpu_count = 2
  }

  read_pool_config {
    node_count = 1
  }

  labels = {
    environment = "devtest"
    role        = "replica"
    managed_by  = "terraform"
  }
}
```

---

## Tasks (Planning)

1. **Cluster Design**:
   - [ ] Document cluster configuration (name, location, project)
   - [ ] Define HA strategy (multi-zone, us-east4-a + us-east4-b)
   - [ ] Plan backup policy (daily, 30-day retention, 2 AM window)
   - [ ] Plan PITR configuration (7-day recovery window)

2. **Sizing**:
   - [ ] Calculate vCPU requirements (2 vCPUs for devtest)
   - [ ] Calculate memory requirements (8 GB for 7 services)
   - [ ] Plan storage (100 GB initial, auto-scale to 1 TB)
   - [ ] Estimate connection pool size (~105 connections total)

3. **Network**:
   - [ ] Document PSC auto-creation (AlloyDB handles PSC when psc_enabled = true)
   - [ ] Document network configuration (pcc-vpc-nonprod reference)

4. **Security**:
   - [ ] Document authentication methods (PostgreSQL + IAM)
   - [ ] Plan encryption (at-rest, in-transit)
   - [ ] Document network security (PSC, private IP only)

---

## Dependencies

**Upstream**:
- Phase 1.4: Network infrastructure deployed
- `pcc-vpc-nonprod` VPC exists in `pcc-prj-net-shared`
- `pcc-prj-app-devtest` GCP project exists

**Downstream**:
- Phase 2.2: Terraform module will implement this design
- Phase 2.3: Module call will reference this cluster
- Phase 2.4: 7 databases will be created in this cluster

---

## Validation Criteria

- [ ] Cluster configuration documented (HA, backup, PITR)
- [ ] Sizing calculated (2 vCPUs, 8 GB memory, 100 GB storage)
- [ ] Network configuration planned (PSC, private IP)
- [ ] Security requirements documented
- [ ] Terraform resource patterns defined
- [ ] Ready for Phase 2.2 (module creation)

---

## Deliverables

- [ ] Cluster design document (this file)
- [ ] Terraform resource patterns (examples above)
- [ ] Sizing calculations
- [ ] Network configuration reference
- [ ] Ready for module implementation

---

## References

- Phase 1.4 (Network infrastructure)
- Phase 2.2 (Terraform module implementation)
- ðŸ”— AlloyDB Docs: https://cloud.google.com/alloydb/docs
- ðŸ”— AlloyDB PSC: https://cloud.google.com/alloydb/docs/configure-private-service-connect
- ðŸ”— AlloyDB HA: https://cloud.google.com/alloydb/docs/instance-high-availability
- ðŸ”— AlloyDB Backups: https://cloud.google.com/alloydb/docs/backup-restore
- ðŸ”— AlloyDB PITR: https://cloud.google.com/alloydb/docs/point-in-time-recovery

---

## Notes

- **Devtest Sizing**: Conservative sizing (2 vCPUs, 8 GB) appropriate for devtest. Production will scale up.
- **Storage Auto-Scaling**: Starts at 100 GB, grows automatically to 1 TB as needed.
- **HA Failover**: Automatic, transparent to applications. ~5min downtime during zone failure.
- **Backup Window**: 2-4 AM EST chosen for low-traffic period (adjust if needed).
- **PITR**: 7-day window provides good balance between recovery capability and cost.
- **PSC Auto-Creation**: AlloyDB automatically creates PSC service attachments when `psc_enabled = true`. No manual forwarding rules needed.
- **Connection Methods**: Use AlloyDB Auth Proxy (recommended) or direct connection via auto-generated PSC DNS name.

---

## Time Estimate

**Planning**: 20-25 minutes
- 5 min: Document cluster configuration
- 5 min: Design HA and backup strategy
- 5 min: Calculate sizing (vCPUs, memory, storage)
- 5 min: Document network and security configuration

---

**Next Phase**: 2.2 - Create AlloyDB Terraform Module
