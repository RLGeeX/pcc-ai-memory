# BL-003: Implement Google Workspace Group-Based Authentication for ArgoCD

## Metadata
- **Status**: Backlog
- **Priority**: High
- **Estimated Effort**: 3-4 hours
- **Dependencies**: 
  - ArgoCD deployed and operational (✅ Complete)
  - Google OAuth configured (✅ Complete)
  - Google Workspace Admin access required
- **Related Phases**: Phase 6.16 (Ingress Deployment)
- **Created**: 2025-01-17
- **Category**: Security, Authentication, RBAC

## Problem Statement

### Current State
ArgoCD is deployed and accessible at https://argocd.nonprod.pcconnect.ai with Google OAuth authentication working. Users can successfully authenticate via Google Workspace accounts, but their group memberships are not being propagated to ArgoCD for Role-Based Access Control (RBAC) decisions.

### Observed Behavior
When users log in and check their user info in ArgoCD:
- Username/email appears correctly
- Groups array is empty: `[]`
- This prevents RBAC policies from working

### Expected Behavior
After login, users should see their Google Workspace group memberships in their ArgoCD user info, enabling RBAC policies like:
```yaml
policy.csv: |
  g, gcp-admins@pcconnect.ai, role:admin
  g, gcp-devops@pcconnect.ai, role:admin
  g, gcp-developers@pcconnect.ai, role:readonly
```

### Root Cause
Google's standard OpenID Connect (OIDC) implementation does not include group memberships in ID tokens or UserInfo responses. The current Dex configuration uses the generic OIDC connector which only provides:
- Email address
- Name
- Profile picture
- Email verification status

Group information requires additional API calls to Google Workspace Directory API with proper authorization.

## Technical Background

### Google Workspace API Requirements
To retrieve group memberships, you need:

1. **Domain-Wide Delegation**: A service account that can impersonate users to query Directory API
2. **API Scopes**: Specific OAuth scopes for reading group information
3. **Admin Consent**: Google Workspace admin must authorize the service account

### Dex Connector Types for Google
Dex supports two connector types for Google:

1. **OIDC Connector** (current):
   - Generic OAuth2/OIDC implementation
   - Only provides standard OIDC claims (email, name, picture)
   - Does NOT include groups
   - What we're using now

2. **Google Connector** (needed):
   - Google-specific implementation
   - Uses Directory API to fetch groups
   - Requires service account with domain-wide delegation
   - Can filter groups by admin email query
   - Supports multiple group retrieval strategies

## Solution Options

### Option A: Configure Dex Google Connector with Service Account (Recommended)

This is the proper solution for production use.

**Pros:**
- Native ArgoCD/Dex support
- Secure and scalable
- Works with existing RBAC policies
- Standard Google Workspace integration pattern

**Cons:**
- Requires Google Workspace Admin setup
- Service account requires domain-wide delegation (elevated permissions)
- More complex initial configuration

**Implementation Steps:**

#### Step 1: Create Service Account for Directory API Access

```bash
# Set project context
PROJECT_ID="pcc-nonprod-01"
SA_NAME="argocd-dex-directory"
SA_EMAIL="${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

# Create service account
gcloud iam service-accounts create ${SA_NAME} \
  --project=${PROJECT_ID} \
  --display-name="ArgoCD Dex Directory API Access" \
  --description="Service account for ArgoCD Dex to query Google Workspace groups via Directory API"

# Enable Admin SDK API
gcloud services enable admin.googleapis.com --project=${PROJECT_ID}

# Generate service account key
gcloud iam service-accounts keys create ~/argocd-dex-directory-key.json \
  --iam-account=${SA_EMAIL} \
  --project=${PROJECT_ID}

# Store key in Secret Manager
gcloud secrets create argocd-dex-directory-key \
  --project=${PROJECT_ID} \
  --replication-policy="user-managed" \
  --locations="us-east4" \
  --data-file="$HOME/argocd-dex-directory-key.json"

# Grant ExternalSecrets SA access
gcloud secrets add-iam-policy-binding argocd-dex-directory-key \
  --project=${PROJECT_ID} \
  --member="serviceAccount:external-secrets-nonprod@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# Securely delete local key file
shred -vfz -n 10 ~/argocd-dex-directory-key.json
```

#### Step 2: Configure Domain-Wide Delegation in Google Workspace

**Manual steps in Google Admin Console:**

1. Navigate to: https://admin.google.com
2. Go to **Security** → **Access and data control** → **API Controls**
3. Click **Manage Domain Wide Delegation**
4. Click **Add new**
5. Enter Client ID from service account:
   ```bash
   # Get the Client ID (Unique ID) from service account details
   gcloud iam service-accounts describe ${SA_EMAIL} \
     --project=${PROJECT_ID} \
     --format='value(oauth2ClientId)'
   ```
6. Add OAuth Scopes:
   ```
   https://www.googleapis.com/auth/admin.directory.group.readonly
   https://www.googleapis.com/auth/admin.directory.user.readonly
   ```
7. Click **Authorize**

#### Step 3: Create ExternalSecret for Directory API Key

Create file: `k8s/core/argocd-nonprod/devtest/external-secrets/dex-directory-key-secret.yaml`

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-dex-directory-key
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: argocd-dex-directory-key
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        serviceAccountJSON: "{{ .serviceAccountJSON | b64dec }}"
  dataFrom:
    - extract:
        key: argocd-dex-directory-key
        decodingStrategy: Base64
```

Add to kustomization.yaml:
```yaml
resources:
  - external-secrets/admin-password-secret.yaml
  - external-secrets/dex-google-secret.yaml
  - external-secrets/dex-directory-key-secret.yaml  # ADD THIS LINE
```

Apply:
```bash
cd ~/pcc/core/pcc-app-argo-config/argocd-nonprod/devtest
kustomize build . | kubectl apply -f -
```

#### Step 4: Update Dex Configuration

Edit `argocd-cm-patch.yaml`:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  url: https://argocd.nonprod.pcconnect.ai
  dex.config: |
    connectors:
    - type: google
      id: google
      name: Google Workspace
      config:
        issuer: https://accounts.google.com
        clientID: $dex.google.clientID
        clientSecret: $dex.google.clientSecret
        redirectURI: https://argocd.nonprod.pcconnect.ai/api/dex/callback
        
        # Service account for Directory API access
        serviceAccountFilePath: /var/run/secrets/dex-directory/serviceAccountJSON
        
        # Admin email for directory queries (must be a super admin)
        adminEmail: chris@pcconnect.ai
        
        # Fetch groups from Directory API
        fetchGroups: true
        
        # Optional: Filter groups by query
        # Only return groups matching this pattern
        groupSearchFilter: "(email:gcp-*)"
```

**Configuration Notes:**
- `type: google` - Uses Google-specific connector (not generic OIDC)
- `serviceAccountFilePath` - Path to service account key in pod
- `adminEmail` - Google Workspace super admin email to impersonate for Directory API queries
- `fetchGroups: true` - Enable group retrieval
- `groupSearchFilter` - Optional, limits which groups are returned (reduces API calls)

#### Step 5: Mount Service Account Key in Dex Pod

Edit the ArgoCD Dex deployment to mount the secret.

Create patch file: `dex-deployment-patch.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-dex-server
  namespace: argocd
spec:
  template:
    spec:
      volumes:
        - name: dex-directory-key
          secret:
            secretName: argocd-dex-directory-key
            items:
              - key: serviceAccountJSON
                path: serviceAccountJSON
      containers:
        - name: dex
          volumeMounts:
            - name: dex-directory-key
              mountPath: /var/run/secrets/dex-directory
              readOnly: true
```

Add to kustomization.yaml:
```yaml
patchesStrategicMerge:
  - argocd-cm-patch.yaml
  - argocd-cmd-params-cm-patch.yaml
  - argocd-rbac-cm-patch.yaml
  - argocd-secret-patch.yaml
  - argocd-server-service-patch.yaml
  - dex-deployment-patch.yaml  # ADD THIS LINE
```

#### Step 6: Apply Changes and Restart Dex

```bash
cd ~/pcc/core/pcc-app-argo-config/argocd-nonprod/devtest

# Apply configuration
kustomize build . | kubectl apply -f -

# Restart Dex to pick up new configuration
kubectl rollout restart deployment/argocd-dex-server -n argocd

# Watch pod restart
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-dex-server -w

# Check logs
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-dex-server --tail=50
```

#### Step 7: Validate Group Retrieval

1. Log out of ArgoCD
2. Log back in via Google OAuth
3. Click on user icon → "User Info"
4. Verify groups array is populated:
   ```json
   {
     "iss": "https://argocd.nonprod.pcconnect.ai/api/dex",
     "sub": "...",
     "groups": [
       "gcp-admins@pcconnect.ai",
       "gcp-devops@pcconnect.ai"
     ],
     "email": "chris@pcconnect.ai"
   }
   ```

5. Verify RBAC works:
   - Member of `gcp-admins@pcconnect.ai` should have admin access
   - Member of `gcp-developers@pcconnect.ai` should have readonly access

#### Step 8: Test and Validate

**Test Cases:**

1. **Admin user test:**
   ```bash
   # User in gcp-admins@pcconnect.ai group
   # Should see "role:admin" capabilities:
   # - Can create/edit applications
   # - Can sync applications
   # - Can delete applications
   # - Can view logs
   ```

2. **Developer user test:**
   ```bash
   # User in gcp-developers@pcconnect.ai group
   # Should see "role:readonly" capabilities:
   # - Can view applications
   # - Can view logs
   # - CANNOT create/edit/delete applications
   # - CANNOT sync applications
   ```

3. **Unauthorized user test:**
   ```bash
   # User NOT in any mapped groups
   # Should see default readonly access
   # - Can view applications
   # - Cannot perform any modifications
   ```

#### Step 9: Commit Configuration

```bash
cd ~/pcc/core/pcc-app-argo-config

git add argocd-nonprod/devtest/external-secrets/dex-directory-key-secret.yaml
git add argocd-nonprod/devtest/dex-deployment-patch.yaml
git add argocd-nonprod/devtest/argocd-cm-patch.yaml
git add argocd-nonprod/devtest/kustomization.yaml

git commit -m "feat(argocd): implement Google Workspace group-based RBAC

- Add Directory API service account key as ExternalSecret
- Configure Dex Google connector with domain-wide delegation
- Mount service account key in Dex pod
- Enable group fetching from Google Workspace Directory API
- Filter groups to gcp-* pattern for efficiency

Resolves: BL-003"

git push origin main
```

---

### Option B: Email-Based Role Assignment (Temporary Workaround)

Use individual email addresses instead of groups in RBAC policies.

**Pros:**
- Quick to implement
- No Google Workspace Admin access needed
- Works with existing OAuth setup

**Cons:**
- Must update RBAC config for every user addition/removal
- Doesn't scale well
- Defeats purpose of group-based access control
- Manual maintenance burden

**Implementation:**

Edit `argocd-rbac-cm-patch.yaml`:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly
  
  policy.csv: |
    # Admin users (by email)
    g, chris@pcconnect.ai, role:admin
    g, admin2@pcconnect.ai, role:admin
    
    # DevOps users (by email)
    g, devops1@pcconnect.ai, role:admin
    g, devops2@pcconnect.ai, role:admin
    
    # Developer users (by email)
    g, dev1@pcconnect.ai, role:readonly
    g, dev2@pcconnect.ai, role:readonly
```

Apply:
```bash
cd ~/pcc/core/pcc-app-argo-config/argocd-nonprod/devtest
kustomize build . | kubectl apply -f -
```

This is **NOT recommended** for production but can serve as a stopgap measure.

---

### Option C: External Identity Provider with Group Support

Use a different IdP that natively supports group claims (Okta, Auth0, Azure AD, etc.).

**Pros:**
- Groups work out of the box
- More flexible RBAC options
- Better for multi-cloud environments

**Cons:**
- Requires migrating away from Google OAuth
- Additional cost for IdP service
- More complexity in identity stack
- Not aligned with GCP-native approach

**Not recommended** for this project as we're standardizing on Google Workspace.

---

## Recommended Approach

**Use Option A: Configure Dex Google Connector with Service Account**

This is the proper, production-ready solution that:
- Aligns with Google Workspace as primary identity provider
- Enables scalable group-based RBAC
- Follows security best practices
- Is well-documented and supported by ArgoCD/Dex community

## Security Considerations

### Service Account Permissions
The service account created for Directory API access requires domain-wide delegation, which is a powerful permission. To minimize risk:

1. **Least Privilege Scopes**: Only grant the minimum required scopes:
   - `admin.directory.group.readonly` - Read group memberships
   - `admin.directory.user.readonly` - Read user details
   - Do NOT grant write or admin scopes

2. **Restricted Use**: Service account key should ONLY be accessible to:
   - Secret Manager (encrypted at rest)
   - ExternalSecrets Operator (via Workload Identity)
   - Dex pod (mounted as volume, in-memory only)

3. **Key Rotation**: Plan for periodic rotation of service account key:
   ```bash
   # Create new key
   gcloud iam service-accounts keys create new-key.json \
     --iam-account=${SA_EMAIL}
   
   # Update secret
   gcloud secrets versions add argocd-dex-directory-key \
     --data-file=new-key.json
   
   # ExternalSecrets will auto-sync to K8s secret within refreshInterval
   
   # Delete old key (after validating new key works)
   gcloud iam service-accounts keys delete OLD_KEY_ID \
     --iam-account=${SA_EMAIL}
   ```

4. **Audit Logging**: Enable Cloud Audit Logs for Directory API access:
   ```bash
   # This is typically already enabled, but verify
   gcloud logging read "protoPayload.serviceName=admin.googleapis.com" \
     --limit=10 \
     --format=json
   ```

### Group Filter Best Practices
Using `groupSearchFilter` is recommended to:
- Reduce API calls to Google Workspace
- Limit exposure to only relevant groups
- Improve performance

Example filters:
```yaml
# Only groups starting with "gcp-"
groupSearchFilter: "(email:gcp-*)"

# Multiple patterns (OR logic)
groupSearchFilter: "(email:gcp-*) OR (email:argo-*)"

# Exclude specific groups
groupSearchFilter: "(email:gcp-*) -(email:gcp-test-*)"
```

### Admin Email Impersonation
The `adminEmail` configured in Dex must be a Google Workspace super admin or have the **Groups Admin** role. This account is impersonated by the service account to query Directory API.

**Best Practice**: Create a dedicated admin account for API access rather than using a personal admin account.

## Rollback Plan

If issues occur after implementing Option A:

### 1. Immediate Rollback to OIDC Connector
```bash
# Edit ConfigMap to revert to OIDC connector
kubectl edit configmap argocd-cm -n argocd

# Change connector type from "google" back to "oidc"
# Remove: serviceAccountFilePath, adminEmail, fetchGroups, groupSearchFilter
# Keep: issuer, clientID, clientSecret, redirectURI

# Restart Dex
kubectl rollout restart deployment/argocd-dex-server -n argocd
```

### 2. Rollback Git Configuration
```bash
cd ~/pcc/core/pcc-app-argo-config
git revert <commit-hash>
git push origin main
```

### 3. Re-apply Previous Configuration
```bash
cd ~/pcc/core/pcc-app-argo-config/argocd-nonprod/devtest
kustomize build . | kubectl apply -f -
```

Users will still be able to authenticate, but groups will not be populated (returns to current state).

## Validation Checklist

After implementation, verify:

- [ ] Service account created with correct permissions
- [ ] Service account key stored in Secret Manager
- [ ] Domain-wide delegation configured in Google Workspace Admin
- [ ] ExternalSecret syncing key to K8s secret
- [ ] Dex pod mounting service account key volume
- [ ] Dex configuration updated with Google connector
- [ ] Dex pod restarted and running without errors
- [ ] Dex logs show successful group retrieval
- [ ] User can log in via Google OAuth
- [ ] User info shows populated groups array
- [ ] Admin user has admin access (can create/edit apps)
- [ ] Developer user has readonly access (cannot edit apps)
- [ ] Unauthorized user denied access or gets default readonly

## References

### ArgoCD Documentation
- [ArgoCD User Management](https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/)
- [ArgoCD RBAC Configuration](https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/)
- [ArgoCD Dex Integration](https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/google/)

### Dex Documentation
- [Dex Google Connector](https://dexidp.io/docs/connectors/google/)
- [Dex OIDC Connector](https://dexidp.io/docs/connectors/oidc/)

### Google Workspace API
- [Directory API - Groups](https://developers.google.com/admin-sdk/directory/reference/rest/v1/groups)
- [Domain-Wide Delegation](https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority)
- [OAuth 2.0 Scopes for Google APIs](https://developers.google.com/identity/protocols/oauth2/scopes#admin-directory)

### Security Best Practices
- [GCP Service Account Best Practices](https://cloud.google.com/iam/docs/best-practices-service-accounts)
- [Secret Manager Security](https://cloud.google.com/secret-manager/docs/best-practices)

## Estimated Timeline

| Task | Duration | Notes |
|------|----------|-------|
| Create service account and store key | 15 min | Automated via gcloud commands |
| Configure domain-wide delegation | 20 min | Manual steps in Google Admin Console |
| Create ExternalSecret and deployment patch | 15 min | YAML configuration |
| Update Dex configuration | 10 min | Edit ConfigMap patch |
| Apply and test | 30 min | Deploy, restart, verify |
| Validate RBAC with multiple users | 30 min | Test different group memberships |
| Documentation and commit | 20 min | Git commit, update docs |
| **Total** | **2.5-3 hours** | Excludes waiting for Google Workspace admin approval |

Add 30-60 minutes buffer for troubleshooting.

## Notes

- The deprecated `hostedDomains` parameter is no longer needed with the Google connector approach, as domain restriction is already enforced by the "Internal" OAuth consent screen setting.
- The Google connector handles token refresh and group caching internally, reducing API calls to Google Workspace.
- Group memberships are fetched at login time. If a user's groups change in Google Workspace, they must log out and log back in to ArgoCD to see updated permissions.
- Consider implementing a webhook or periodic sync if real-time group updates are critical (advanced configuration, not covered here).

## Success Criteria

Implementation is considered complete when:

1. ✅ Service account configured with domain-wide delegation
2. ✅ Dex using Google connector (not generic OIDC)
3. ✅ Users logging in see populated groups in user info
4. ✅ RBAC policies correctly enforced based on group membership
5. ✅ Admin users can manage applications
6. ✅ Readonly users cannot modify applications
7. ✅ Configuration committed to Git
8. ✅ No authentication errors in Dex logs
9. ✅ No excessive API calls to Google Workspace (check quotas)
10. ✅ Security audit logging enabled and working
