# BL-002: WireGuard Custom Image with Cloud Build GCE Image Builder

**Status**: Backlog
**Priority**: Medium
**Estimated Effort**: 3-4 hours
**Dependencies**: None
**Related**: Phase VPN (wireguard-vpn.tf), BL-001

## Overview

Create custom GCE image with WireGuard and dependencies pre-installed using Cloud Build and `gce-image-builder`. This reduces WireGuard instance startup time from ~10 minutes to ~1-2 minutes by pre-baking packages into the base image. Cloud Build can be triggered automatically when Google updates the upstream Debian base image.

## Current State (Startup Script Installation)

**Architecture**:
- Instances start from public `debian-cloud/debian-12` image
- Startup script installs packages on every boot:
  - WireGuard + wireguard-tools (~2 min)
  - dnsmasq (~1 min)
  - google-cloud-cli upgrade (~5-7 min)
- Total startup time: ~10 minutes
- Package installation logs fill Cloud Logging

**Resources**:
- Instance template: `module.wireguard_instance_template`
- Startup script: Installs packages, fetches keys, configures WireGuard
- Base image: `projects/debian-cloud/global/images/family/debian-12`

## Target State (Custom Image)

**Architecture**:
```
Cloud Build Trigger:
  ├─ Manual trigger OR
  ├─ GitHub commit to image config OR
  └─ Scheduled (weekly, checks for debian-12 updates)
       ↓
  Cloud Build runs gce-image-builder
       ↓
  Creates: wireguard-base-debian12-YYYYMMDD
       ↓
  Instance template references custom image
       ↓
  Startup time: ~1-2 minutes (no package installation)
```

**Key Changes**:
- Custom image contains pre-installed:
  - WireGuard + wireguard-tools
  - dnsmasq (pre-configured)
  - google-cloud-cli (latest)
  - jq, curl, other utilities
- Startup script only:
  - Fetches keys from Secret Manager
  - Fetches wg0.conf from GCS
  - Configures and starts services
- Image updated weekly (or on-demand)
- Old images automatically cleaned up

## Implementation Details

### 1. Create Image Builder Configuration

**File**: `/home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base/image-config.yaml`

```yaml
# GCE Image Builder configuration for WireGuard base image
# Documentation: https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/gce-image-builder

substitutions:
  _IMAGE_FAMILY: wireguard-base-debian12
  _IMAGE_PROJECT: pcc-prj-devops-nonprod
  _SOURCE_IMAGE_FAMILY: debian-12
  _SOURCE_IMAGE_PROJECT: debian-cloud
  _ZONE: us-east4-a
  _NETWORK: projects/pcc-prj-network-nonprod/global/networks/pcc-vpc-nonprod
  _SUBNET: projects/pcc-prj-network-nonprod/regions/us-east4/subnetworks/pcc-prj-devops-nonprod

# Base configuration
timeout: 1800s  # 30 minutes
options:
  machineType: 'E2_HIGHCPU_8'  # Fast builds
  diskSizeGb: 20

steps:
  # Step 1: Create temporary VM from Debian base image
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'create-disk'
    args:
      - 'compute'
      - 'disks'
      - 'create'
      - 'wireguard-image-builder-disk-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'
      - '--image-family=${_SOURCE_IMAGE_FAMILY}'
      - '--image-project=${_SOURCE_IMAGE_PROJECT}'
      - '--size=20GB'
      - '--type=pd-ssd'

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'create-instance'
    args:
      - 'compute'
      - 'instances'
      - 'create'
      - 'wireguard-image-builder-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'
      - '--machine-type=e2-standard-2'
      - '--network=${_NETWORK}'
      - '--subnet=${_SUBNET}'
      - '--no-address'  # Use internal IP only
      - '--disk=name=wireguard-image-builder-disk-${BUILD_ID},boot=yes,auto-delete=no'
      - '--metadata-from-file=startup-script=./build-image.sh'
      - '--scopes=cloud-platform'

  # Step 2: Wait for startup script to complete
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'wait-for-build'
    args:
      - 'compute'
      - 'ssh'
      - 'wireguard-image-builder-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'
      - '--tunnel-through-iap'
      - '--command=while ! test -f /tmp/image-build-complete; do sleep 5; done; echo "Build complete"'
    timeout: 1200s  # 20 minutes max

  # Step 3: Stop instance (required before creating image)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'stop-instance'
    args:
      - 'compute'
      - 'instances'
      - 'stop'
      - 'wireguard-image-builder-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'

  # Step 4: Create image from disk
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'create-image'
    args:
      - 'compute'
      - 'images'
      - 'create'
      - 'wireguard-base-debian12-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--source-disk=wireguard-image-builder-disk-${BUILD_ID}'
      - '--source-disk-zone=${_ZONE}'
      - '--family=${_IMAGE_FAMILY}'
      - '--description=WireGuard base image with pre-installed packages (Debian 12)'
      - '--labels=purpose=wireguard-base,environment=all,build-id=${BUILD_ID}'

  # Step 5: Cleanup - Delete instance
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'delete-instance'
    args:
      - 'compute'
      - 'instances'
      - 'delete'
      - 'wireguard-image-builder-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'
      - '--quiet'

  # Step 6: Cleanup - Delete disk
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'delete-disk'
    args:
      - 'compute'
      - 'disks'
      - 'delete'
      - 'wireguard-image-builder-disk-${BUILD_ID}'
      - '--project=${_IMAGE_PROJECT}'
      - '--zone=${_ZONE}'
      - '--quiet'

  # Step 7: Cleanup old images (keep last 3)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'cleanup-old-images'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud compute images list \
          --project=${_IMAGE_PROJECT} \
          --filter="family:${_IMAGE_FAMILY}" \
          --format="value(name)" \
          --sort-by="~creationTimestamp" \
          | tail -n +4 \
          | xargs -r -I {} gcloud compute images delete {} \
            --project=${_IMAGE_PROJECT} \
            --quiet

images:
  - '${_IMAGE_PROJECT}/wireguard-base-debian12-${BUILD_ID}'

tags:
  - 'wireguard'
  - 'custom-image'
  - 'debian-12'
```

### 2. Create Image Build Script

**File**: `/home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base/build-image.sh`

```bash
#!/bin/bash
# WireGuard Base Image Build Script
# Runs on temporary GCE instance during Cloud Build
# Installs and configures packages for WireGuard VPN

set -e
set -o pipefail

LOG_FILE="/var/log/image-build.log"

log() {
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "===== Starting WireGuard base image build ====="

###############################################################################
# Update System
###############################################################################

log "Updating package lists..."
apt-get update

log "Upgrading existing packages..."
apt-get upgrade -y

###############################################################################
# Install Core Packages
###############################################################################

log "Installing WireGuard and dependencies..."
apt-get install -y \
  wireguard \
  wireguard-tools \
  dnsmasq \
  jq \
  curl \
  wget \
  net-tools \
  iptables \
  resolvconf

###############################################################################
# Upgrade Google Cloud CLI
###############################################################################

log "Upgrading Google Cloud CLI to latest version..."
apt-get install -y google-cloud-cli

###############################################################################
# Configure dnsmasq (Template)
###############################################################################

log "Pre-configuring dnsmasq..."

# Create dnsmasq config directory
mkdir -p /etc/dnsmasq.d

# Create template config (will be customized by startup script)
cat > /etc/dnsmasq.d/wireguard.conf << 'EOF'
# WireGuard VPN DNS Configuration
# This file is managed by startup script
# DO NOT EDIT - will be overwritten on boot

# Listen on WireGuard interface
interface=wg0
bind-interfaces

# DNS server for VPN clients
listen-address=10.100.0.1

# Upstream DNS servers (Google DNS)
server=8.8.8.8
server=8.8.4.4

# Local domain resolution
domain=vpn.pcconnect.internal

# DHCP disabled (WireGuard manages IPs)
no-dhcp-interface=wg0

# Logging
log-queries
log-facility=/var/log/dnsmasq.log

# Cache settings
cache-size=1000
EOF

# Disable dnsmasq for now (startup script will enable after WireGuard is up)
systemctl disable dnsmasq
systemctl stop dnsmasq

###############################################################################
# Configure WireGuard Directory
###############################################################################

log "Creating WireGuard directories..."
mkdir -p /etc/wireguard
chmod 700 /etc/wireguard

# Create placeholder config (startup script will replace with real config)
cat > /etc/wireguard/wg0.conf << 'EOF'
# WireGuard Configuration
# This file is managed by startup script
# DO NOT EDIT - will be overwritten on boot from GCS
EOF

chmod 600 /etc/wireguard/wg0.conf

###############################################################################
# Configure Kernel Parameters
###############################################################################

log "Configuring kernel parameters for routing..."

cat >> /etc/sysctl.conf << 'EOF'

# WireGuard VPN - IP Forwarding
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
EOF

# Apply now (will persist on reboot)
sysctl -p

###############################################################################
# Create Helper Scripts Directory
###############################################################################

log "Creating helper scripts directory..."
mkdir -p /usr/local/bin/wireguard-helpers
chmod 755 /usr/local/bin/wireguard-helpers

###############################################################################
# Clean Up
###############################################################################

log "Cleaning up package manager caches..."
apt-get clean
apt-get autoclean
apt-get autoremove -y

# Clear logs (Cloud Build will capture this script's output)
> /var/log/syslog
> /var/log/auth.log
> /var/log/kern.log

# Clear cloud-init logs
rm -rf /var/lib/cloud/*

# Clear machine-id (will regenerate on first boot)
truncate -s 0 /etc/machine-id

# Clear SSH host keys (will regenerate on first boot)
rm -f /etc/ssh/ssh_host_*

###############################################################################
# Verification
###############################################################################

log "Verifying installed packages..."

if ! command -v wg &> /dev/null; then
  log "ERROR: WireGuard not installed"
  exit 1
fi

if ! command -v dnsmasq &> /dev/null; then
  log "ERROR: dnsmasq not installed"
  exit 1
fi

if ! command -v gcloud &> /dev/null; then
  log "ERROR: gcloud CLI not installed"
  exit 1
fi

log "Package versions:"
log "- WireGuard: $(wg version)"
log "- dnsmasq: $(dnsmasq --version | head -1)"
log "- gcloud: $(gcloud version --format='value(version)')"
log "- jq: $(jq --version)"

###############################################################################
# Complete
###############################################################################

log "===== WireGuard base image build complete ====="
log "Image is ready for snapshot"

# Signal completion to Cloud Build
touch /tmp/image-build-complete

exit 0
```

### 3. Update Instance Template to Use Custom Image

**File**: `/home/jfogarty/pcc/infra/pcc-devops-infra/terraform/environments/nonprod/wireguard-vpn.tf`

**Change**:
```hcl
module "wireguard_instance_template" {
  source = "git::ssh://git@github-pcc/PORTCoCONNECT/pcc-tf-library.git//modules/instance-template?ref=v0.1.0"

  project_id  = var.project_id
  name        = "wireguard-vpn-template"
  region      = var.region
  machine_type = "e2-small"

  # CHANGE: Use custom image instead of public Debian
  source_image_family  = "wireguard-base-debian12"
  source_image_project = var.project_id  # pcc-prj-devops-nonprod

  # REMOVE: No longer needed (pre-installed in image)
  # source_image_family  = "debian-12"
  # source_image_project = "debian-cloud"

  network_project_id = var.network_project_id
  network_name       = var.vpc_network_name
  subnetwork_name    = var.subnetwork_name

  enable_external_ip = true
  nat_ip             = module.wireguard_ip.address
  network_tier       = "STANDARD"

  service_account_email = module.wireguard_sa.email

  tags = ["wireguard-vpn"]

  labels = {
    purpose     = "wireguard-vpn"
    environment = var.environment
  }

  # Startup script now only configures (no package installation)
  metadata_startup_script = file("${path.module}/startup-script-slim.sh")
}
```

### 4. Create Simplified Startup Script

**File**: `/home/jfogarty/pcc/infra/pcc-devops-infra/terraform/environments/nonprod/startup-script-slim.sh`

**Content** (abbreviated - packages already installed):
```bash
#!/bin/bash
# WireGuard VPN Startup Script (Slim Version for Custom Image)
# Packages are pre-installed - this script only configures

set -e
set -o pipefail

log() {
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

log "===== Starting WireGuard VPN configuration ====="

# NOTE: WireGuard, dnsmasq, gcloud already installed in base image

###############################################################################
# Fetch Configuration from Secret Manager & GCS
###############################################################################

log "Fetching WireGuard keys from Secret Manager..."
# ... (same as before)

log "Fetching wg0.conf from GCS..."
# ... (same as before)

###############################################################################
# Configure WireGuard
###############################################################################

log "Configuring WireGuard interface..."
# ... (same as before)

###############################################################################
# Start Services
###############################################################################

log "Starting WireGuard service..."
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0

log "Starting dnsmasq service..."
systemctl enable dnsmasq
systemctl start dnsmasq

log "===== WireGuard VPN configuration complete ====="
log "Startup time: ~1-2 minutes (vs ~10 minutes with package installation)"

exit 0
```

### 5. Create Cloud Build Trigger

**Via gcloud**:
```bash
cd /home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base

# Create trigger
gcloud builds triggers create manual \
  --name="wireguard-base-image-build" \
  --project=pcc-prj-devops-nonprod \
  --build-config=image-config.yaml \
  --description="Build WireGuard base image with pre-installed packages" \
  --region=us-east4

# OR: Create GitHub trigger (if config is in repo)
gcloud builds triggers create github \
  --name="wireguard-base-image-build-auto" \
  --project=pcc-prj-devops-nonprod \
  --repo-name=pcc-devops-infra \
  --repo-owner=PORTCoCONNECT \
  --branch-pattern="^main$" \
  --build-config=images/wireguard-base/image-config.yaml \
  --included-files="images/wireguard-base/**" \
  --description="Auto-build WireGuard image on config changes"

# OR: Create scheduled trigger (weekly rebuild to get Debian updates)
gcloud builds triggers create manual \
  --name="wireguard-base-image-weekly" \
  --project=pcc-prj-devops-nonprod \
  --build-config=image-config.yaml \
  --description="Weekly rebuild for Debian security updates"
  # Note: Schedule via Cloud Scheduler invoking this trigger
```

**Via Terraform** (future enhancement):
```hcl
resource "google_cloudbuild_trigger" "wireguard_image_manual" {
  project     = var.project_id
  name        = "wireguard-base-image-build"
  description = "Build WireGuard base image with pre-installed packages"
  location    = "us-east4"

  filename = "images/wireguard-base/image-config.yaml"

  # Manual trigger only
  trigger_template {
    branch_name = "main"
    repo_name   = "pcc-devops-infra"
  }

  disabled = true  # Enable when ready
}
```

### 6. Automated Weekly Rebuild (Optional)

**Create Cloud Scheduler job** to trigger weekly image rebuild:

```bash
# Create Cloud Scheduler job
gcloud scheduler jobs create http wireguard-image-weekly-rebuild \
  --project=pcc-prj-devops-nonprod \
  --location=us-east4 \
  --schedule="0 2 * * 0" \
  --time-zone="America/New_York" \
  --uri="https://cloudbuild.googleapis.com/v1/projects/pcc-prj-devops-nonprod/locations/us-east4/triggers/wireguard-base-image-build:run" \
  --http-method=POST \
  --oauth-service-account-email="cloud-build-scheduler@pcc-prj-devops-nonprod.iam.gserviceaccount.com" \
  --description="Weekly WireGuard base image rebuild (Sundays at 2 AM EST)"

# Grant Cloud Build permissions to service account
gcloud projects add-iam-policy-binding pcc-prj-devops-nonprod \
  --member="serviceAccount:cloud-build-scheduler@pcc-prj-devops-nonprod.iam.gserviceaccount.com" \
  --role="roles/cloudbuild.builds.editor"
```

**Rationale**: Weekly rebuilds ensure the image includes latest Debian security patches without manual intervention.

## Testing Plan

1. **Manual Build Test** (Phase 1):
   ```bash
   cd /home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base
   gcloud builds submit --config=image-config.yaml --project=pcc-prj-devops-nonprod
   ```
   - Verify image created: `gcloud compute images list --project=pcc-prj-devops-nonprod --filter="family:wireguard-base-debian12"`
   - Check build logs for errors

2. **Instance Launch Test** (Phase 2):
   - Update instance template to use custom image
   - Deploy new instance via MIG
   - Verify startup completes in ~1-2 minutes (check `journalctl -u google-startup-scripts`)
   - Verify WireGuard service running: `systemctl status wg-quick@wg0`

3. **Connection Test** (Phase 3):
   - Connect client to VPN
   - Verify handshake succeeds
   - Test connectivity to AlloyDB PSC endpoint

4. **Image Update Test** (Phase 4):
   - Trigger image rebuild
   - Verify new image created with timestamp
   - Verify MIG rolling update picks up new image
   - Verify old images cleaned up (keep last 3)

## Rollback Plan

**If custom image causes issues**:

1. Revert instance template to use public Debian image:
   ```hcl
   source_image_family  = "debian-12"
   source_image_project = "debian-cloud"
   ```

2. Revert to full startup script (with package installation)

3. Apply terraform changes

4. Investigate and fix custom image build

5. Retry when ready

## Cost Impact

**Current** (public image + startup installation):
- No custom image storage: $0
- Instance startup time: ~10 minutes (CloudLogging storage for verbose package logs)

**New** (custom image):
- Custom image storage: ~$0.50/month (5 GB image, 3 versions = 15 GB)
- Cloud Build usage: ~$0.50/month (weekly 30-min builds)
- Instance startup time: ~1-2 minutes (minimal logs)
- **Total additional cost**: ~$1/month

**Benefits**:
- 80% faster startup time (10 min → 1-2 min)
- Reduced Cloud Logging costs (fewer package installation logs)
- Consistent package versions across all instances
- Security patches via weekly automated rebuilds

## Success Criteria

✅ Cloud Build successfully creates custom image
✅ Image contains WireGuard, dnsmasq, gcloud CLI pre-installed
✅ Instance boots from custom image in ~1-2 minutes
✅ WireGuard service starts without errors
✅ VPN client connects successfully
✅ Weekly scheduled rebuilds work automatically
✅ Old images automatically cleaned up (retain last 3)

## Dependencies

- Cloud Build API enabled
- IAM permissions for Cloud Build service account:
  - `compute.instanceAdmin` (create/delete temporary instances)
  - `compute.imageUser` (create images)
  - `iam.serviceAccountUser` (use service account)
- Shared VPC connectivity for build instance
- GCS bucket for startup script (optional)

## Related Files

- `/home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base/image-config.yaml` (NEW)
- `/home/jfogarty/pcc/infra/pcc-devops-infra/images/wireguard-base/build-image.sh` (NEW)
- `/home/jfogarty/pcc/infra/pcc-devops-infra/terraform/environments/nonprod/wireguard-vpn.tf` (UPDATE)
- `/home/jfogarty/pcc/infra/pcc-devops-infra/terraform/environments/nonprod/startup-script-slim.sh` (NEW)

## Notes

- Custom images are project-specific (not shared across projects by default)
- Image family allows easy "latest" reference in Terraform
- Weekly rebuilds ensure Debian security patches are included
- Cloud Build is more automated than Packer for GCP-native workflows
- Image cleanup prevents unbounded storage costs

## References

- [GCE Image Builder GitHub](https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/gce-image-builder)
- [Cloud Build Documentation](https://cloud.google.com/build/docs)
- [Custom Image Best Practices](https://cloud.google.com/compute/docs/images/create-delete-deprecate-private-images)
- [Cloud Scheduler with Cloud Build](https://cloud.google.com/build/docs/automate-builds-cloud-scheduler)
