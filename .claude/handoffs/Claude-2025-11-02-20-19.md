# Session Handoff: AlloyDB PSC DNS Architecture Refactor

## Project Context
Working on DNS resolution for AlloyDB Private Service Connect (PSC) endpoints to enable IAM authentication from WireGuard VPN clients and GKE pods. The initial approach using DNS forwarding zones was completely wrong - metadata server (169.254.169.254) is not a DNS resolver and can't be used as a forwarding target.

## Problem Discovery
**Initial Wrong Approach**: Created `dns-psc-forwarding` module that used Cloud DNS forwarding zones pointing to 169.254.169.254. This failed with `Error 400: Invalid value for 'entity.managedZone.forwardingConfig.targetNameServers[0]': '169.254.169.254', invalid`.

**Root Cause**: 169.254.169.254 is Google's metadata server, NOT a DNS server. Cloud DNS forwarding zones require routable DNS resolver IPs.

**Correct Solution**: Use private DNS zones with A records mapping `*.alloydb-psc.goog` to PSC endpoint IPs.

## Architecture Discovered Through Conversation

### Key Insight (User-Driven)
DNS zone should live in **network project** (pcc-foundation-infra), NOT in service projects, because:
- Both WireGuard VPN (devops project) and GKE pods (app projects) need DNS resolution
- Shared VPC means one zone can serve all service projects
- Each service project adds A records to the shared zone

### Final Architecture
```
Network Project (pcc-prj-network-nonprod):
  └─ DNS Zone: alloydb-psc.goog (created in pcc-foundation-infra)
      └─ Visible to: pcc-vpc-nonprod

Service Project (pcc-prj-devops-nonprod):
  └─ DNS A Record: *.alloydb-psc.goog → 10.24.128.3 (PSC endpoint IP)
      └─ Created via dns-psc-record module in alloydb-psc-consumer.tf

Result: WireGuard clients + GKE pods resolve PSC DNS → connect via alloydb-auth-proxy --psc
```

## Completed Tasks

### 1. pcc-tf-library (v0.1.0 force-updated)
- ❌ **Deleted**: `modules/dns-psc-forwarding/` (forwarding zone approach - wrong)
- ✅ **Created**: `modules/dns-psc-record/` (A record module - correct)
  - **Files**: main.tf, variables.tf, outputs.tf, versions.tf, README.md
  - **Inputs**: network_project_id, zone_name, dns_name, psc_endpoint_ip
  - **Outputs**: record_name, record_type, record_data, zone_name, psc_endpoint_ip
  - **Function**: Creates `*.{dns_name}` A record pointing to PSC endpoint IP

### 2. pcc-foundation-infra
- ✅ **Created**: `terraform/modules/network/dns.tf`
  - Two private DNS zones (nonprod + prod)
  - Zone names: `alloydb-psc-zone` and `alloydb-psc-zone-prod`
  - DNS name: `alloydb-psc.goog.` (same for both)
  - Visible to respective VPCs only
- ✅ **Updated**: `terraform/modules/network/outputs.tf`
  - Added `dns_zones` output map
- ✅ **Fixed**: Corrected variable references to `var.network_projects.nonprod` and `var.network_projects.prod`

### 3. pcc-devops-infra
- ✅ **Updated**: `terraform/environments/nonprod/alloydb-psc-consumer.tf`
  - Added `module "alloydb_psc_dns_record"` call
  - References: zone_name="alloydb-psc-zone", dns_name="alloydb-psc.goog."
  - Uses: `google_compute_address.alloydb_psc_endpoint.address` for IP
- ✅ **Fixed**: `terraform/environments/nonprod/outputs.tf`
  - Corrected module reference from `alloydb_psc_dns` to `alloydb_psc_dns_record`
  - Updated outputs to match actual module outputs

### 4. Git Commits (All Pushed)
- pcc-tf-library: "feat: replace dns-psc-forwarding with dns-psc-record module" (v0.1.0 force-updated)
- pcc-foundation-infra: "feat: add DNS zones for AlloyDB PSC endpoints" + "fix: correct DNS zone project_id variable reference"
- pcc-devops-infra: "feat: add DNS record for AlloyDB PSC endpoint" + "fix: correct DNS module reference in outputs"

## Pending Tasks - CRITICAL BLOCKER DISCOVERED

### AlloyDB IAM Authentication Bootstrap Problem
**User provided feedback** at end of session revealing a **chicken-and-egg problem**:

1. **IAM Database Users Need PostgreSQL Grants**: `google_alloydb_user` with `user_type = ALLOYDB_IAM_USER` creates IAM user in AlloyDB, but doesn't grant PostgreSQL database permissions (GRANT ALL PRIVILEGES, etc.)

2. **Grants Require Superuser Connection**: Must connect as postgres user to run GRANT statements

3. **Cluster Has No Users By Default**: AlloyDB clusters create without postgres password

4. **Three Components Needed**:
   - AlloyDB IAM user (via Terraform `google_alloydb_user`)
   - IAM roles on service account (`roles/alloydb.client`, `roles/alloydb.databaseUser`)
   - PostgreSQL database permissions (via SQL GRANT statements)

### User Asked for Recommendation
I proposed three options:

**Option A - Cloud Function (Most Automated)**
- Trigger on cluster creation
- Auto-runs GRANT statements
- Complex setup

**Option B - Bootstrap Script (Semi-Automated) - MY RECOMMENDATION**
- Create `scripts/bootstrap-alloydb-iam.sh` in pcc-app-shared-infra
- One-time manual run from developer machine via WireGuard VPN
- Script connects via auth-proxy using postgres password (from Secret Manager)
- Runs GRANT statements for all IAM users from terraform output
- Repeatable if IAM users change

**Option C - Terraform null_resource with local-exec**
- Works but requires local machine with PSC access
- Less portable

**User Response**: Asked me to create handoff (brain done for the day)

## Next Steps - FOR TOMORROW MORNING

### 1. Review My Recommendation
User needs to decide on approach for IAM authentication bootstrap:
- Read my analysis above (Option A/B/C)
- Decide: Cloud Function vs Bootstrap Script vs Something Else
- I recommended **Option B (Bootstrap Script)** because:
  - Minimal manual work (one script run)
  - Works with existing WireGuard VPN setup
  - Repeatable and auditable (script in git)
  - No complex Cloud Functions needed

### 2. If Bootstrap Script Approach Chosen
Need to implement in phases:

**Phase 1 - AlloyDB Module Updates** (`pcc-tf-library/modules/alloydb-cluster/`)
- Create `users.tf` with two user types:
  - `google_alloydb_user.postgres_admin` (BUILT_IN, password from Secret Manager)
  - `google_alloydb_user.iam_users` (for_each over map, ALLOYDB_IAM_USER)
- Add variables: `postgres_password` (sensitive), `iam_database_users` (map)
- Update outputs to include user emails

**Phase 2 - Secret Manager Setup** (`pcc-app-shared-infra`)
- Store postgres password in Secret Manager BEFORE deploying AlloyDB
- Reference via `data.google_secret_manager_secret_version` in terraform

**Phase 3 - IAM Roles** (`pcc-app-shared-infra/terraform/environments/devtest/iam.tf`)
- Grant `roles/alloydb.client` to service accounts
- Grant `roles/alloydb.databaseUser` to service accounts

**Phase 4 - Bootstrap Script** (`pcc-app-shared-infra/scripts/`)
- Create `bootstrap-alloydb-iam.sh`
- Reads terraform outputs for IAM user emails
- Connects via alloydb-auth-proxy using postgres password
- Runs GRANT statements for each IAM user

### 3. Immediate Deployment Blockers
**CANNOT DEPLOY** pcc-foundation-infra or pcc-devops-infra yet because:
- foundation-infra creates DNS zones (ready)
- devops-infra tries to create DNS records (ready)
- BUT: No one can actually CONNECT to AlloyDB yet (IAM auth not configured)
- Need to solve IAM bootstrap problem first

### 4. Terraform Apply Order (Once IAM Solved)
1. Apply pcc-foundation-infra (creates DNS zones)
2. Apply pcc-app-shared-infra with IAM users (creates AlloyDB users + IAM roles)
3. Run bootstrap script (grants PostgreSQL permissions)
4. Apply pcc-devops-infra (creates PSC endpoint + DNS record)
5. Test from WireGuard VPN: `alloydb-auth-proxy --psc <instance-uri>`

## References
- **My Analysis**: See "Proposed Solution" section with Option A/B/C above
- **User Feedback**: Full IAM authentication requirements (6 steps)
- **DNS Module**: `/home/jfogarty/pcc/core/pcc-tf-library/modules/dns-psc-record/`
- **DNS Zones**: `/home/jfogarty/pcc/core/pcc-foundation-infra/terraform/modules/network/dns.tf`
- **PSC Consumer**: `/home/jfogarty/pcc/infra/pcc-devops-infra/terraform/environments/nonprod/alloydb-psc-consumer.tf`
- **AlloyDB Module**: `/home/jfogarty/pcc/core/pcc-tf-library/modules/alloydb-cluster/` (needs users.tf)

## Key Decisions Made
1. ✅ DNS zones in network project (not service projects)
2. ✅ Separate zone creation (foundation-infra) from record creation (service projects)
3. ✅ Private zones with A records (not forwarding zones)
4. ⏸️ IAM authentication bootstrap approach (decision pending tomorrow)

## Metadata
- **Session Duration**: ~6 hours (long session, multiple false starts)
- **Timestamp**: 2025-11-02 20:19 EST
- **Context**: Continued from previous WireGuard VPN session
- **User State**: Mentally exhausted, needs fresh perspective tomorrow morning
- **Critical**: User explicitly said "supposed to be quick thing" - this became complex, need pragmatic solution tomorrow
